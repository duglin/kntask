source .demoscript

kn service delete test > /dev/null 2>&1 

comment We start with a simple app
doit cat app

comment --pause And the Dockerfile used to build its image
doit cat Dockerfile.app

comment --pause "Deploy it... (as a 'task')"
doit kn service create test --image duglin/app -l type=task
URL=$(tail -1 out)

comment --pause Now hit it
doit curl -s ${URL}

comment --paues "Demo streaming"
doit --ignorerc timeout 10s ./client ${URL}

comment --pause Check pods
doit kubectl get pods

comment --pause "Load it up (10 clients)"
doit ./load -l 10 0 ${URL}

comment --pause "See pods didn't scale"
doit kubectl get pods

comment --pause Now set concurrency to 1
doit kn service update test --concurrency-limit=1

comment --pause "Load it up again"
doit ./load -l 10 0 ${URL}

comment --pause "See pods DID scale"
doit kubectl get pods

comment --pause "Create a KnService that uses certain nodes"
doit kn service create test2 --image duglin/app --min-scale=1 \
	-l type=task -l flavor=2x16 --concurrency-limit=1
URL=$(tail -1 out)

doit "kubectl get pods -o custom-columns=NAME:.metadata.name,NODE:.status.hostIP,FLAVOR:.metadata.labels.flavor && kubectl get nodes -o custom-columns=NAME:.metadata.name,FLAVOR:.metadata.labels.flavor"

comment --pause "Load it to show it only scales on the selected node"
doit ./load -l 10 0 ${URL}

doit "kubectl get pods -o custom-columns=NAME:.metadata.name,NODE:.status.hostIP,FLAVOR:.metadata.labels.flavor && kubectl get nodes -o custom-columns=NAME:.metadata.name,FLAVOR:.metadata.labels.flavor"

comment --pause "Clean..."
doit kn service delete test test2
